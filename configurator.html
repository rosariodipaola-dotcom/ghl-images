<!DOCTYPE html>
<html>
<head>
    <title>GHL Image Konfigurator V4 (Text-Box)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; color: #333; }
        .main-wrapper { display: flex; gap: 20px; flex-wrap: wrap; }
        
        /* Linke Spalte */
        .controls { 
            width: 340px; 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        /* Rechte Spalte */
        #preview-area { 
            position: relative; 
            display: inline-block; 
            border: 4px solid white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            line-height: 0; 
        }
        
        #target-img { max-width: 100%; cursor: crosshair; }
        
        .marker { 
            position: absolute; 
            pointer-events: none; 
            white-space: nowrap;
            line-height: 1;
            /* Der Marker wird jetzt durch die Box ersetzt, aber wir lassen ihn für Fallbacks */
            transform: translateY(0); 
        }
        
        /* Die Box im Konfigurator */
        .preview-box {
            position: absolute;
            background-color: rgba(255,255,255,0.7); /* Standard semi-transparent */
            border-radius: 4px;
            pointer-events: none;
            display: none; /* Erstmal versteckt */
        }

        /* Formular UI */
        label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; display: block; margin-top: 12px; color: #777; }
        input[type="text"], input[type="number"], select, button { width: 100%; padding: 10px; box-sizing: border-box; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        input[type="color"] { width: calc(100% - 2px); height: 38px; padding: 0; border: none; margin-top: 5px; }
        textarea { width: 100%; height: 90px; font-family: monospace; font-size: 11px; margin-top: 20px; border-radius: 6px; border: 1px solid #ccc; padding: 8px;}
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        h2 { margin-top: 0; color: #333; }
        .hint { font-size: 12px; color: #666; margin-bottom: 20px; display: block; line-height: 1.4; background: #eef; padding: 10px; border-radius: 6px;}
        
        #serverUrl { background-color: #f0f0f0; color: #555; cursor: not-allowed; }

        /* Checkbox-Stil */
        .checkbox-container { display: flex; align-items: center; margin-top: 10px; }
        .checkbox-container input { width: auto; margin-right: 8px; }
        .checkbox-container label { margin-top: 0; margin-bottom: 0; text-transform: none; font-weight: normal; font-size: 14px; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="controls">
            <h2>Bild Konfigurator</h2>
            <span class="hint">
                <strong>Schritt 1:</strong> Bild URL eintragen.<br>
                <strong>Schritt 2:</strong> Ins Bild klicken für Position.<br>
                <strong>Schritt 3:</strong> Code kopieren.
            </span>

            <label>1. Render App URL (FIXIERT):</label>
            <input type="text" id="serverUrl" value="https://rosario-ghl-images.onrender.com" readonly>
            
            <label>2. Hintergrundbild URL (aus GHL):</label>
            <input type="text" id="bgUrl" placeholder="https://..." onchange="loadImage()">
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div class="row">
                <div class="col">
                    <label>Test-Name:</label>
                    <input type="text" id="testName" value="sebastian" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Text-Korrektur:</label>
                    <select id="textCase" onchange="updatePreview()">
                        <option value="title" selected>Abc (Auto-Korrektur)</option>
                        <option value="upper">ABC (ALLES GROSS)</option>
                        <option value="lower">abc (alles klein)</option>
                        <option value="none">Original (Wie GHL)</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Schriftart:</label>
                    <select id="fontName" onchange="updatePreview()">
                        <option value="marker">Marker (Reviews)</option>
                        <option value="handwriting">Handschrift</option>
                        <option value="roboto_bold">Roboto (Fett)</option>
                        <option value="roboto_reg">Roboto (Normal)</option>
                        <option value="open_bold">Open Sans (Fett)</option>
                        <option value="open_reg">Open Sans (Normal)</option>
                        <option value="elegant">Elegant</option>
                        <option value="impact">Impact</option>
                    </select>
                </div>
                <div class="col">
                     <label>Größe:</label>
                     <input type="number" id="fontSize" value="60" oninput="updatePreview()">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>X-Position:</label>
                    <input type="number" id="posX" value="50" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Y-Position:</label>
                    <input type="number" id="posY" value="50" oninput="updatePreview()">
                </div>
            </div>

            <label>Textfarbe:</label>
            <input type="color" id="fontColor" value="#000000" oninput="updatePreview()">

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="checkbox-container">
                <input type="checkbox" id="showBox" onchange="updatePreview()">
                <label for="showBox">Rechteckige Box unter Text</label>
            </div>
            <div class="row">
                <div class="col">
                    <label>Box Farbe:</label>
                    <input type="color" id="boxColor" value="#ffffff" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Box Polsterung (px):</label>
                    <input type="number" id="boxPadding" value="10" oninput="updatePreview()">
                </div>
            </div>

            <label>Fertiger Code für GHL Email:</label>
            <textarea id="resultLink" onclick="this.select()"></textarea>
        </div>

        <div>
            <div id="preview-area">
                <img id="target-img" src="" alt="Bild lädt...">
                <div id="preview-box-element" class="preview-box"></div>
                <div id="marker" class="marker"></div> </div>
        </div>
    </div>

    <script>
        const img = document.getElementById('target-img');
        const marker = document.getElementById('marker');
        const previewBoxElement = document.getElementById('preview-box-element');
        const RENDER_URL = "https://rosario-ghl-images.onrender.com"; // Deine Render URL

        window.onload = function() {
            if(localStorage.getItem('bgUrl')) {
                document.getElementById('bgUrl').value = localStorage.getItem('bgUrl');
                loadImage();
            }
            // Box-Einstellungen aus LocalStorage laden
            if(localStorage.getItem('showBox')) document.getElementById('showBox').checked = (localStorage.getItem('showBox') === 'true');
            if(localStorage.getItem('boxColor')) document.getElementById('boxColor').value = localStorage.getItem('boxColor');
            if(localStorage.getItem('boxPadding')) document.getElementById('boxPadding').value = localStorage.getItem('boxPadding');
            
            updatePreview(); // Initialer Aufruf
        }

        function loadImage() {
            const url = document.getElementById('bgUrl').value;
            if(url) {
                img.src = url;
                localStorage.setItem('bgUrl', url);
                updatePreview();
            }
        }

        img.addEventListener('click', function(e) {
            const rect = img.getBoundingClientRect();
            document.getElementById('posX').value = Math.round(e.clientX - rect.left);
            document.getElementById('posY').value = Math.round(e.clientY - rect.top);
            updatePreview();
        });

        function updatePreview() {
            const x = parseFloat(document.getElementById('posX').value);
            const y = parseFloat(document.getElementById('posY').value);
            const size = parseFloat(document.getElementById('fontSize').value);
            const color = document.getElementById('fontColor').value;
            let text = document.getElementById('testName').value;
            const casing = document.getElementById('textCase').value;
            const font = document.getElementById('fontName').value;
            
            // Box-Parameter
            const showBox = document.getElementById('showBox').checked;
            const boxColor = document.getElementById('boxColor').value;
            const boxPadding = parseFloat(document.getElementById('boxPadding').value);

            // JS Vorschau der Text-Transformation
            if(casing === 'upper') text = text.toUpperCase();
            else if(casing === 'lower') text = text.toLowerCase();
            else if(casing === 'title') {
                text = text.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            }

            // Marker (Text) Style
            let fontFamily = 'Arial, sans-serif';
            let fontWeight = 'normal';
            if(font === 'marker') fontFamily = '"Comic Sans MS", sans-serif';
            if(font.includes('bold')) fontWeight = 'bold';
            if(font === 'roboto_bold' || font === 'roboto_reg') fontFamily = 'Roboto, Arial';
            if(font === 'impact') fontFamily = 'Impact';
            if(font === 'elegant') fontFamily = 'serif';

            marker.innerText = text;
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.fontSize = size + 'px';
            marker.style.color = color;
            marker.style.fontFamily = fontFamily;
            marker.style.fontWeight = fontWeight;

            // Box im Konfigurator zeichnen (Näherung)
            if (showBox) {
                const tempDiv = document.createElement('div');
                tempDiv.style.fontFamily = fontFamily;
                tempDiv.style.fontSize = size + 'px';
                tempDiv.style.fontWeight = fontWeight;
                tempDiv.style.position = 'absolute'; // Wichtig für Breite/Höhe
                tempDiv.style.whiteSpace = 'nowrap';
                tempDiv.textContent = text;
                document.body.appendChild(tempDiv); // Temporär hinzufügen, um Maße zu bekommen
                
                const textWidth = tempDiv.offsetWidth;
                const textHeight = tempDiv.offsetHeight;
                document.body.removeChild(tempDiv);

                previewBoxElement.style.display = 'block';
                previewBoxElement.style.left = (x - boxPadding) + 'px';
                previewBoxElement.style.top = (y - boxPadding) + 'px';
                previewBoxElement.style.width = (textWidth + (2 * boxPadding)) + 'px';
                previewBoxElement.style.height = (textHeight + (2 * boxPadding)) + 'px';
                previewBoxElement.style.backgroundColor = boxColor;
            } else {
                previewBoxElement.style.display = 'none';
            }

            // Einstellungen im LocalStorage speichern
            localStorage.setItem('showBox', showBox);
            localStorage.setItem('boxColor', boxColor);
            localStorage.setItem('boxPadding', boxPadding);


            updateLink();
        }

        function updateLink() {
            const server = RENDER_URL.replace(/\/$/, ""); 
            const bg = encodeURIComponent(document.getElementById('bgUrl').value);
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const size = document.getElementById('fontSize').value;
            const color = document.getElementById('fontColor').value.replace('#', '');
            const font = document.getElementById('fontName').value;
            const casing = document.getElementById('textCase').value;
            
            // Box Parameter für den Link
            const showBox = document.getElementById('showBox').checked;
            const boxColor = document.getElementById('boxColor').value.replace('#', '');
            const boxPadding = document.getElementById('boxPadding').value;
            
            if(!bg) return;

            // Die GHL Custom Field Merge-Tags
            const dynamicBgUrl = "{{contact.custom_fields.hintergrund_url}}"; // ACHTUNG: Hier 'hintergrund_url' anpassen, falls anders benannt
            const firstNameTag = "{{ contact.first_name }}";
            
            let finalUrl = `${server}/generate?bg=${dynamicBgUrl}&x=${x}&y=${y}&size=${size}&color=${color}&font=${font}&case=${casing}&text=${firstNameTag}`;

            if (showBox) {
                finalUrl += `&box=true&box_color=${boxColor}&box_padding=${boxPadding}`;
            }
            
            document.getElementById('resultLink').value = `<img src="${finalUrl}" width="100%" alt="Hallo ${firstNameTag}">`;
        }
    </script>
</body>
</html>
