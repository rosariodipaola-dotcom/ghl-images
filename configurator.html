<!DOCTYPE html>
<html>
<head>
    <title>GHL Image Konfigurator V3.1 (Auto-URL)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; color: #333; }
        .main-wrapper { display: flex; gap: 20px; flex-wrap: wrap; }
        
        /* Linke Spalte */
        .controls { 
            width: 340px; 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        /* Rechte Spalte */
        #preview-area { 
            position: relative; 
            display: inline-block; 
            border: 4px solid white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            line-height: 0; 
        }
        
        #target-img { max-width: 100%; cursor: crosshair; }
        
        .marker { 
            position: absolute; 
            pointer-events: none; 
            white-space: nowrap;
            line-height: 1;
            transform: translateY(0); 
        }

        /* Formular UI */
        label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; display: block; margin-top: 12px; color: #777; }
        input, select, button { width: 100%; padding: 10px; box-sizing: border-box; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        textarea { width: 100%; height: 90px; font-family: monospace; font-size: 11px; margin-top: 20px; border-radius: 6px; border: 1px solid #ccc; padding: 8px;}
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        h2 { margin-top: 0; color: #333; }
        .hint { font-size: 12px; color: #666; margin-bottom: 20px; display: block; line-height: 1.4; background: #eef; padding: 10px; border-radius: 6px;}
        
        /* Style für das deaktiverte Feld */
        #serverUrl { background-color: #f0f0f0; color: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="controls">
            <h2>Bild Konfigurator</h2>
            <span class="hint">
                <strong>Schritt 1:</strong> Bild URL eintragen.<br>
                <strong>Schritt 2:</strong> Ins Bild klicken für Position.<br>
                <strong>Schritt 3:</strong> Code kopieren.
            </span>

            <label>1. Render App URL (FIXIERT):</label>
            <input type="text" id="serverUrl" value="https://rosario-ghl-images.onrender.com" readonly>
            
            <label>2. Hintergrundbild URL (aus GHL):</label>
            <input type="text" id="bgUrl" placeholder="https://..." onchange="loadImage()">
            
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            
            <div class="row">
                <div class="col">
                    <label>Test-Name:</label>
                    <input type="text" id="testName" value="sebastian" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Text-Korrektur:</label>
                    <select id="textCase" onchange="updatePreview()">
                        <option value="title" selected>Abc (Auto-Korrektur)</option>
                        <option value="upper">ABC (ALLES GROSS)</option>
                        <option value="lower">abc (alles klein)</option>
                        <option value="none">Original (Wie GHL)</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>Schriftart:</label>
                    <select id="fontName" onchange="updatePreview()">
                        <option value="marker">Marker (Reviews)</option>
                        <option value="handwriting">Handschrift</option>
                        <option value="roboto_bold">Roboto (Fett)</option>
                        <option value="roboto_reg">Roboto (Normal)</option>
                        <option value="open_bold">Open Sans (Fett)</option>
                        <option value="open_reg">Open Sans (Normal)</option>
                        <option value="elegant">Elegant</option>
                        <option value="impact">Impact</option>
                    </select>
                </div>
                <div class="col">
                     <label>Größe:</label>
                     <input type="number" id="fontSize" value="60" oninput="updatePreview()">
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label>X-Position:</label>
                    <input type="number" id="posX" value="50" oninput="updatePreview()">
                </div>
                <div class="col">
                    <label>Y-Position:</label>
                    <input type="number" id="posY" value="50" oninput="updatePreview()">
                </div>
            </div>

            <label>Textfarbe:</label>
            <input type="color" id="fontColor" value="#000000" oninput="updatePreview()">
            
            <label>Fertiger Code für GHL Email:</label>
            <textarea id="resultLink" onclick="this.select()"></textarea>
        </div>

        <div>
            <div id="preview-area">
                <img id="target-img" src="" alt="Bild lädt...">
                <div id="marker" class="marker"></div>
            </div>
        </div>
    </div>

    <script>
        const img = document.getElementById('target-img');
        const marker = document.getElementById('marker');
        // Die feste Server URL
        const RENDER_URL = "https://rosario-ghl-images.onrender.com";

        window.onload = function() {
            // Die Render URL muss nicht mehr geladen werden, da sie fest ist
            if(localStorage.getItem('bgUrl')) {
                document.getElementById('bgUrl').value = localStorage.getItem('bgUrl');
                loadImage();
            }
        }

        function loadImage() {
            const url = document.getElementById('bgUrl').value;
            if(url) {
                img.src = url;
                localStorage.setItem('bgUrl', url);
                updatePreview();
            }
        }

        img.addEventListener('click', function(e) {
            const rect = img.getBoundingClientRect();
            document.getElementById('posX').value = Math.round(e.clientX - rect.left);
            document.getElementById('posY').value = Math.round(e.clientY - rect.top);
            updatePreview();
        });

        function updatePreview() {
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const size = document.getElementById('fontSize').value;
            const color = document.getElementById('fontColor').value;
            let text = document.getElementById('testName').value;
            const casing = document.getElementById('textCase').value;
            const font = document.getElementById('fontName').value;

            // JS Vorschau der Text-Transformation
            if(casing === 'upper') text = text.toUpperCase();
            else if(casing === 'lower') text = text.toLowerCase();
            else if(casing === 'title') {
                text = text.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            }

            let fontFamily = 'Arial, sans-serif';
            let fontWeight = 'normal';

            if(font === 'marker') fontFamily = '"Comic Sans MS", sans-serif';
            if(font.includes('bold')) fontWeight = 'bold';
            if(font === 'roboto_bold' || font === 'roboto_reg') fontFamily = 'Roboto, Arial';
            if(font === 'impact') fontFamily = 'Impact';
            if(font === 'elegant') fontFamily = 'serif';

            marker.innerText = text;
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.fontSize = size + 'px';
            marker.style.color = color;
            marker.style.fontFamily = fontFamily;
            marker.style.fontWeight = fontWeight;

            updateLink();
        }

        function updateLink() {
            // Jetzt wird RENDER_URL direkt verwendet!
            const server = RENDER_URL.replace(/\/$/, ""); 
            const bg = encodeURIComponent(document.getElementById('bgUrl').value);
            const x = document.getElementById('posX').value;
            const y = document.getElementById('posY').value;
            const size = document.getElementById('fontSize').value;
            const color = document.getElementById('fontColor').value.replace('#', '');
            const font = document.getElementById('fontName').value;
            const casing = document.getElementById('textCase').value;
            
            if(!bg) return;

            // Hier verwenden wir das GHL Custom Field Merge-Tag für den Hintergrund:
            const dynamicBgUrl = "{{ custom_fields.DEIN_CUSTOM_FIELD_NAME }}"; 
            
            // Wichtig: Wir ersetzen den festen bg-Parameter durch das GHL Merge-Tag,
            // sodass der Link dann in GHL funktioniert und das Custom Field ausgelesen wird.
            const finalUrl = `${server}/generate?bg=${dynamicBgUrl}&x=${x}&y=${y}&size=${size}&color=${color}&font=${font}&case=${casing}&text={{ contact.first_name }}`;
            
            // Hinweis für den Nutzer: Er muss das Custom Field noch anpassen
            document.getElementById('resultLink').value = `<img src="${finalUrl}" width="100%" alt="Hallo {{ contact.first_name }}">`;
        }
    </script>
</body>
</html>